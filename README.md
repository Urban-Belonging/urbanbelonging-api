# urban-belonging-api

This API powers the Urban Belonging mobile app. It performs authentication, handles communication with the database, connects to external services and more. It's intended as the single point of contact for all clients that need to access Urban Belonging.

# Deployment

## Architecture

The stack uses a microservices architecture where image resizing is handled by the [urban-belonging-image-post-processor](https://github.com/Urban-Belonging/urbanbelonging-image-post-processor). All API requests are handled via this API.

Deployment relies on a number of external services.

## External Services

### nginx

Nginx is used as the load balancer/reverse proxy to expose this application to the internet. SSL termination should be handled there.

### Docker

This application should ideally be run within a Docker container, running Node > 12.0.

### MongoDB

MongoDB is used as the database for storing data related to users, photos and annotation/reaction information.

### Redis

Redis is used as an in-memory cache for authentication (JWT) tokens.

### RabbitMQ

RabbitMQ is used as a message broker to communicate with the [urban-belonging-image-post-processor](https://github.com/Urban-Belonging/urbanbelonging-image-post-processor) microservice.

### SendGrid

SendGrid is used as the email provider for sending emails to users for user activation, password reset and user generation.

### S3 Storage & CDN

An Amazon S3 compatible storage is required for storing photos. It must be available publicly on the internet or exposed via a (HTTPS) CDN.

### Expo Push API

Push notifications are delivered to devices via the Expo Push API. This does not require any specific authentication: device tokens are generated by the native devices and if correct will deliver push notifications successfully.

# Configuration

Most of the configuration can be done via environment variables. The table below describes each environment variable and its purpose

| Name                         | Description                                                        |
| ---------------------------- | ------------------------------------------------------------------ |
| NODE_ENV                     | The environment the application is running in                      |
| API_KEY_JSON_PATH            | The absolute path to the JSON file that stores API keys            |
| MONGODB_CORRECTION_URI       | The connection URI of the MongoDB instance                         |
| RABBITMQ_URL                 | The AMQP URL of the RabbitMQ instance                              |
| REDIS_HOST                   | The hostname of the Redis instance                                 |
| SENDGRID_API_KEY             | The SendGrid API key used for sending emails                       |
| SPACES_CDN_ACCESS_KEY_ID     | The access key ID of the S3 compatible storage used for photos     |
| SPACES_CDN_SECRET_ACCESS_KEY | The secret access key of the S3 compatible storage used for photos |

# Running a development server

You can start a development server by running `yarn run dev` in the terminal which will automatically rebuild your code, typecheck and restart the server. Some environment variables are needed for development which are slightly different to production - see [./bin/dev](https://github.com/Urban-Belonging/urbanbelonging-api/blob/main/bin/dev) for reference. Ensure the required external services are running before starting the development server.

# Authentication

Users register using the app. They are sent a unique activation code to their email which when entered in the app will activate their user. Password resets use the same mechanism - a code is generated, users enter the code in the app and are then brought to the password reset flow.

## Mobile Apps (JWT)

Authentication for mobile apps is handled by short-lived JSON Web Tokens (JWT) which are cached in an in-memory Redis cache. When clients receive an authentication error due to an expired token, they request a refresh token and automatically retry any failed requests.

## Export/Admin APIs (API Keys)

Data can be exported and admin tasks can be performed using the API via a REST client. Authentication for these endpoints is handled via API key authentication, where a JSON file called `api-keys.json` is placed on the volume the application is running (path configured via environment variables) that defines the API keys and what user ID they correspond to:

```json
{
  "SOME_RANDOM_API_KEY": "USER_ID"
}
```

**Please note:** API keys are tied to specific users. Do not share API keys between users or publish on the internet.

# Configuration: Prompts, Annotations & Reactions

This application has been designed with configuration in mind. The prompts that are generated for users to capture photos, annotate them and react to them are all configured via [prompts.ts](https://github.com/Urban-Belonging/urbanbelonging-api/blob/main/src/lib/prompts.ts). This file is a copy of the prompts.ts file in [UrbanBelonging](https://github.com/Urban-Belonging/urbanbelonging-mobile-application/blob/main/lib/prompts.ts) - not ideal, I know. Whenever you update prompts you must update both files.

This file describes the various types of prompts and the actual (English) copy that's displayed. Localization is performed in the mobile client. Copy is included here because it allows you to export complete data from a Photo Event - without hardcoding the copy here you would need to cross reference it with the mobile app to show the actual text that's displayed to users.

When a Photo Event is created, it uses the prompts at the moment it was created and saves them to the event itself. This means any changes you make to the prompts themselves, such as the options for answers or the type of answer that's being given, will not take effect until you redeploy and then API create another Photo Event.

If you simply want to change the copy that's displayed to users/need to make typo fixes in answer options, you can redeploy the API and ship an OTA update to the mobile app. Users will see the updated text once they have the latest app build.

It's very important not to delete any old prompts in this file as the viewing of older Photo Events relies on this data being present in the front end. All of the data is still persisted to photos/photo events/reactions/annotations, so you can always be sure this data is present on the backend, we just don't send it all to the frontend.

# User Roles

There's 2 types of users: regular users or admins. Regular users can't see any group/photo event creation UI or add others to groups. Admins can create groups, create photo events and invite users to them.

To make someone an admin you must use the admin API. There's a bit of a chicken and the egg problem: you must first create the user, get their user ID, then update the `api-keys.json` file with the user ID. After that you can call the admin API and update their role.

# Demographic Groups

There is a feature in the backend that's completely opaque to clients. The API will try to return photos to users from their own demographic group before other demographic groups to enhance the value of the data for research. Updating demographic groups for users can only be done via the admin API.

# Admin/Export APIs

For administration of user groups, exporting data and other actions which do not apply to regular users, you can use the Admin/Export APIs. They are both authenticated using API keys. Place the API key for your user in the `X-API-Key` header of your HTTP request. Every request you make using your API key will be identified as you - don't share API keys!

### Admin: Update User Role

Used for updating the role of a user. Only users with the role `admin` can see the groups screen. Users have the role `user` by default.

**Endpoint:** `PUT /v1/admin/user/:id/role`

**Request Body:**

```
{
    "role": "admin"
}
```

Returns an object indicating if the request was successful.

### Admin: Update Demographic Groups

Used for updating the demographics of individual users to ensure they receive photos captured by users of the same demographic first when performing a one-by-one reaction. Overwrites any existing demographics applied. You can get the ID of the user group by long pressing on the user group in the list in the mobile app.

**Endpoint:** `PUT /v1/user-group/:id/demographics`

**Request Body:**

```
{
    "users": {
        "EXAMPLE_USER_ID_1": "CASE_SENSITIVE_DEMOGRAPHIC_GROUP_NAME"
    }
}
```

Returns an object describing how many users were updated.

### Export: Photo Event Data

Exports the data from a photo event.

**Endpoint:** `GET /api/v1/photo-event/:id`

Returns an object containing:

- The photo event you are choosing to export
- The user group the photo event belongs to
- The photos in the event
- The members of the group

To keep the response body as small as possible, many objects will contain IDs. You'll need to build your own map to cross reference these.

### Export: Photo Event Walk Data

Exports the walks from a photo event.

**Endpoint:** `GET /api/v1/photo-event/:id/waks`

Returns an object containing:

- The walks completed

This response size from this endpoint can be very large so please use it sparingly.

# Push Notifications

Push notifications are delivered to devices via the Expo Push API. These notifications are dynamically sent using the [PhotoEventMonitor](https://github.com/Urban-Belonging/urbanbelonging-api/blob/main/src/lib/photo-event-monitor/index.ts). This periodically checks if there is an event that has pending push notifications and then delivers notifications to every user in that group. If you want to add push notifications to be sent at specific moments in the lifecycle of a Photo Event, this is the place to do it. The PhotoEventMonitor also stores a cache of recent photo event data.
